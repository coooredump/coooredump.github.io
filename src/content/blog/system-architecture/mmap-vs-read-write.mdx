---
title: å…³äº mmap ä¸ read/write
description: å‰å‡ å¤©åœ¨çœ‹ malloc å®ç°èµ„æ–™çš„æ—¶å€™ï¼Œå‘ç°è‡ªå·±å¹¶ä¸æ˜¯éå¸¸ç†è§£ mmap çš„ä½œç”¨ï¼Œäºæ˜¯æŸ¥äº†ä¸€äº›èµ„æ–™ï¼Œé¡ºä¾¿æŠŠä»¥å‰çš„çŸ¥è¯†æ¢³ç†ä¸€ä¸‹ã€‚
publishDate: 2024-11-01
tags: [ç³»ç»Ÿä¸ä½“ç³»ç»“æ„]
heroImage: { src: ../_img/202501222240708.png }
language: Chinese
comment: true
draft: false
---

> åŸæ–‡é“¾æ¥ï¼šhttps://nineright.github.io/2014/03/12/mmap-io.html

å‰å‡ å¤©åœ¨çœ‹ `malloc` å®ç°èµ„æ–™çš„æ—¶å€™ï¼Œçœ‹åˆ° `mmap`ï¼Œå‘ç°è‡ªå·±å¹¶ä¸æ˜¯éå¸¸ç†è§£ mmap çš„ä½œç”¨ï¼Œäºæ˜¯æŸ¥äº†ä¸€äº›èµ„æ–™ï¼Œé¡ºä¾¿æŠŠä»¥å‰çš„çŸ¥è¯†æ¢³ç†ä¸€ä¸‹ï¼Œäºæ˜¯å°±æœ‰äº†è¿™ç¯‡åšæ–‡ã€‚

Linux ä¸‹å¯¹æ–‡ä»¶çš„è®¿é—®ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ã€‚ä¸€ç§æ˜¯ read/write/seekï¼Œè€Œå¦å¤–ä¸€ç§æ˜¯åˆ©ç”¨ mmap ç³»ç»Ÿè°ƒç”¨å°†æ•´ä¸ªæ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ä¸­ã€‚$[8][9]$å¯¹æ¯”ä¸¤ç§æ–¹å¼çš„æ€§èƒ½ï¼Œæµ‹è¯•ç»“æœå¦‚å›¾ 1ã€2 æ‰€ç¤ºã€‚

> å›¾1ï¼šmmap è¯»å†™æ–‡ä»¶æµ‹è¯•

![img](https://cdn.jsdelivr.net/gh/Wu-yikun/OSS/PicGo/202411011704564.jpeg)

> å›¾2ï¼šmmap å›¾åƒå¤„ç†æ€§èƒ½æµ‹è¯• (scale æ˜¯æµ‹è¯•ç¨‹åºçš„ä¸€ä¸ªå‚æ•°)

![img](https://cdn.jsdelivr.net/gh/Wu-yikun/OSS/PicGo/202411011704724.jpeg)

## mmap çš„ä¼˜åŠ¿

Stackoverflow ä¸Š$[2]$æœ‰ä¸€ä¸ªå¾ˆå¥½çš„è®¨è®ºï¼Œå¯¹æ¯” `read` å’Œ `mmap`ã€‚æ€»ç»“ä¸€ä¸‹ï¼Œé€šå¸¸ä½¿ç”¨ mmap() çš„ä¸‰ç§æƒ…å†µæœ€ç»ˆç›®çš„å…¶å®éƒ½ä¸€æ ·ï¼šæé«˜æ•ˆç‡ã€‚

ğŸ”¥**æé«˜ I/O æ•ˆç‡**ï¼šä¼ ç»Ÿçš„ file I/O ä¸­ read ç³»ç»Ÿè°ƒç”¨é¦–å…ˆä»ç£ç›˜æ‹·è´æ•°æ®åˆ° kernelï¼Œç„¶åå†æŠŠæ•°æ®ä» kernel æ‹·è´åˆ°ç”¨æˆ·å®šä¹‰çš„ buffer ä¸­ï¼ˆå¯èƒ½æ˜¯ heap ä¹Ÿæœ‰å¯èƒ½æ˜¯ stack æˆ–è€…æ˜¯å…¨å±€å˜é‡ä¸­$[6]$ï¼‰ã€‚è€Œ mmap ç›´æ¥ç”±å†…æ ¸æ“åˆ€ï¼Œmmap è¿”å›çš„æŒ‡é’ˆæŒ‡å‘æ˜ å°„å†…å­˜çš„èµ·å§‹ä½ç½®ï¼Œç„¶åå¯ä»¥åƒæ“ä½œå†…å­˜ä¸€æ ·æ“ä½œæ–‡ä»¶ï¼Œè€Œä¸”å¦‚æœæ˜¯ç”¨ read/write å°† buffer å†™å› page cache æ„å‘³ç€æ•´ä¸ªæ–‡ä»¶éƒ½è¦ä¸ç£ç›˜åŒæ­¥ï¼ˆå³ä½¿è¿™ä¸ªæ–‡ä»¶åªæœ‰ä¸ªåˆ« page è¢«ä¿®æ”¹äº†ï¼‰ï¼Œè€Œ mmap çš„åŒæ­¥ç²’åº¦æ˜¯ pageï¼Œå¯ä»¥æ ¹æ® page æ•°æ®ç»“æ„çš„ dirty ä½æ¥å†³å®šæ˜¯å¦éœ€è¦ä¸ disk åŒæ­¥ã€‚è¿™æ˜¯ mmap æ¯” read é«˜æ•ˆçš„ä¸»è¦åŸå› ã€‚å¯¹äºé‚£ç§é¢‘ç¹è¯»å†™åŒä¸€ä¸ªæ–‡ä»¶çš„ç¨‹åºæ›´æ˜¯å¦‚æ­¤ã€‚

**åŒ¿åå†…å­˜æ˜ å°„**ï¼šåŒ¿åå†…å­˜æ˜ å°„æœ‰ç‚¹åƒ malloc()ï¼Œå…¶å® Heap å’Œ BSS æ®µå°±å¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ª anonymous mmap [å›¾ 4]ã€‚æœ‰äº› malloc çš„å®ç°ä¸­ï¼Œå½“è¦åˆ†é…è¾ƒå¤§çš„å†…å­˜å—æ—¶ï¼Œmalloc ä¼šè°ƒç”¨ mmap è¿›è¡ŒåŒ¿åå†…å­˜æ˜ å°„ï¼Œæ­¤æ—¶å†…å­˜æ“ä½œåŒºåŸŸä¸æ˜¯å †åŒºï¼Œå†…å­˜é‡Šæ”¾åä¹Ÿä¼šç›´æ¥å½’è¿˜ç»™ OSï¼Œä¸åƒ heap ä¸­çš„å†…å­˜å¯ä»¥å†åˆ©ç”¨ã€‚åŒ¿åå†…å­˜ä¸æ˜¯ POXIS çš„æ ‡å‡†ï¼Œä½†æ˜¯å‡ ä¹æ‰€æœ‰çš„ OS å®ç°äº†è¿™ä¸ªåŠŸèƒ½ã€‚ä¸€ä¸ªç›®å‰åŠŸèƒ½æœ€å¥½çš„ malloc å®ç° dlmalloc å°±æ˜¯é‡‡ç”¨è¿™ç§æ–¹å¼$[4][5][6]$ã€‚dlmalloc æœ‰ä¸‰ç§åˆ†é…æ–¹å¼ï¼š

- (1) å°äº 64B çš„ exact-size quicklistï¼›
- (2) å°äº 128KB çš„ coalesce quicklistï¼›
- (3) å¯¹äºè¾ƒå¤§è¯·æ±‚ç›´æ¥è°ƒç”¨ mmapã€‚

**å…±äº«å†…å­˜è¿›ç¨‹é€šä¿¡**ï¼šç›¸å¯¹äºç®¡é“ã€æ¶ˆæ¯é˜Ÿåˆ—æ–¹å¼ï¼Œé€šè¿‡å†…å­˜æ˜ å°„çš„æ–¹å¼è¿›ç¨‹é€šä¿¡æ•ˆç‡æ˜æ˜¾æ›´é«˜ï¼Œå®ƒä¸éœ€è¦ä»»åŠ¡æ•°æ®æ‹·è´ã€‚è¯´åˆ°å…±äº«å†…å­˜ï¼Œè¿˜æœ‰ä¸€ç§ System V ä¿ç•™ä¸‹æ¥çš„å†…å­˜å…±äº«æ–¹æ³•å°±æ˜¯ shmget ç›¸å…³ç³»ç»Ÿè°ƒç”¨ã€‚ä¸¤è€…ç›¸æ¯” mmap æ›´åŠ ç®€å•æ˜“ç”¨ä¸€äº›ï¼Œè€Œ shmget æä¾›çš„åŠŸèƒ½æ›´å…¨é¢ä¸€äº›ã€‚

## mmap çš„ä¸€äº›é™åˆ¶

å½“ç„¶ `mmap` ä¹Ÿæœ‰ä¸€å®šçš„é™åˆ¶ã€‚

1. **mmap çš„å¯¹é½æ–¹å¼æ˜¯ page ä¸ºå¤§å°çš„**ï¼Œæœ‰å­˜åœ¨å†…å­˜å†…éƒ¨ç¢ç‰‡çš„å¯èƒ½ï¼ˆè°ƒç”¨çš„æ—¶å€™ length æ²¡æœ‰å¯¹é½)ï¼Œæ‰€ä»¥ **mmap ä¸é€‚åˆå°æ–‡ä»¶**ã€‚
2. **mmap åçš„å†…å­˜å¤§å°ä¸èƒ½æ”¹å˜**ã€‚å½“ä¸€ä¸ªæ–‡ä»¶è¢« mmap åï¼Œå¦‚æœå…¶ä»–ç¨‹åºè¦æ”¹å˜æ–‡ä»¶çš„å¤§å°ï¼Œè¦ç‰¹åˆ«ç•™æ„[8]ã€‚
3. mmap ä¸èƒ½å¤„ç†æ‰€æœ‰ç±»å‹çš„æ–‡ä»¶ï¼Œä¾‹å¦‚ pipesã€ttyã€ç½‘ç»œè®¾å¤‡æ–‡ä»¶å°±ä¸èƒ½å¤„ç†ã€‚
4. mmap è¦æ±‚è¿›ç¨‹æä¾›ä¸€å—è¿ç»­çš„è™šæ‹Ÿå†…å­˜ç©ºé—´ï¼Œå¯¹äºå¤§æ–‡ä»¶ï¼ˆ1Gï¼‰çš„å†…å­˜æ˜ å°„ã€‚æœ‰æ—¶å€™ä¼šå¤±è´¥ã€‚å°½ç®¡ç©ºé—²å†…å­˜å¤§äº 1Gï¼Œä½†æ˜¯å¾ˆæœ‰å¯èƒ½æ‰¾ä¸åˆ°è¿ç»­çš„ 1G çš„å†…å­˜ç©ºé—´ã€‚
5. **mmap å¯¹äºé‚£ç§æ‰¹é‡å†™ (write-only) çš„æƒ…æ™¯å¹¶æ²¡æœ‰ä¼˜åŠ¿**ã€‚

$[1]$è®¨è®ºäº†åœ¨ä¼ ç»Ÿçš„æ•°æ®åº“ä¸­å¯¹æ•°æ®åº“æ–‡ä»¶çš„ç›¸å…³æ“ä½œâ€œä¸ºä»€ä¹ˆä¸ç”¨ mmapï¼Ÿâ€ã€‚ä¼ ç»Ÿæ•°æ®åº“å¯¹ datafile çš„è¯»å†™å¤§éƒ¨åˆ†æ˜¯é€šè¿‡ `open` ç³»ç»Ÿè°ƒç”¨åŠ  `O_DIRECT` æ ‡å¿—ã€‚ä½¿ç”¨ O_DIRECT æ ‡å¿—å¯ä»¥è·³è¿‡ kernel çš„ page cache è€Œç›´æ¥ä¸ block deviceï¼ˆå¦‚ç£ç›˜ï¼‰æ‰“äº¤é“ï¼Œä¸æ™®é€šçš„ read/write ç›¸æ¯”å°‘äº†ä¸€å±‚ç¼“å­˜ (page cache)ï¼Œæ•°æ®åº“å¼€å‘è€…é€šè¿‡å®ç°åœ¨ç”¨æˆ·å±‚çš„é«˜æ•ˆç¼“å­˜æ¥è¾¾åˆ°æé«˜æ•ˆç‡ç›®çš„ã€‚ä½†æ˜¯è¿™å¸¦æ¥å¾ˆå¤§çš„å¤æ‚æ€§é—®é¢˜ï¼Œé¦–å…ˆä½¿ç”¨ O_DIRECT çš„è¯ï¼Œå°±å¿…é¡»ä»¥é¡µä¸ºå•ä½è¿›è¡Œ I/Oï¼Œè€Œä¸”æ—¢ç„¶æ”¾å¼ƒ kernel çš„æä¾› page cache ä»¥åŠç›¸å…³çš„ç¼“å­˜ç­–ç•¥ï¼Œé‚£ä¹ˆæ„å‘³ç€æ˜¯æƒ³é€šè¿‡ O_DIRECT æä¾›è‡ªå·±çš„æ›´å¥½çš„ç¼“å­˜ç­–ç•¥ï¼Œè¿™ä¸ªå¾€å¾€æ˜¯å¾ˆå›°éš¾çš„ã€‚åœ¨ Linus çœ‹æ¥$[12]$ï¼Œâ€œO_DIRECT æ˜¯ä¸€ä¸ªéå¸¸ç³Ÿç³•çš„æ¥å£ï¼Œç›®å‰åªä¸ºæ•°æ®åº“å¼€å‘è€…ä¿ç•™ï¼Œå…¶ä»–äººä½¿ç”¨éƒ½å±äºè„‘æ®‹çš„è¡Œä¸ºâ€ã€‚æ•°æ®åº“å¼€å‘è€…æƒ³é€šè¿‡ç›´æ¥ä¸ device æ‰“äº¤é“ï¼ˆç®€å•è¯´ï¼Œä»–ä»¬è§‰å¾—èƒ½æ¯” OS å¹²å¾—æ›´å¥½ï¼‰ï¼Œæ¥æé«˜ I/O æ€§èƒ½ï¼Œä¾‹å¦‚æä¾›æ›´é€‚åˆæ•°æ®åº“çš„ç¼“å­˜ç­–ç•¥ï¼ˆå¦‚ LIRS ç¼“å­˜ç®—æ³•$[13]$ï¼‰ã€‚ä¾‹å¦‚ Innodb ä¸­é€šè¿‡é…ç½®æ–‡ä»¶çš„å½¢å¼æä¾›äº†ä¸¤ç§æ–¹å¼è¯»å†™æ•°æ®æ–‡ä»¶ï¼Œä¸€ç§æ˜¯ä¼ ç»Ÿçš„ read/write è¯»å†™ï¼Œä¸€ç§æ˜¯ O_DIRECT è®¿é—®ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ O_DIRECT çš„æ€§èƒ½è¦é«˜$[11]$ã€‚

## å¤„ç†é«˜å¹¶å‘çš„æ–¹æ¡ˆ

åœ¨ä½œè€…çœ‹æ¥ï¼Œç”¨ mmap ç®¡ç†æ˜¯ä¸€ä¸ªå¯è¡Œçš„æ–¹æ¡ˆï¼š**ä½¿ç”¨ mmap å¯ä»¥å‡å°‘ kernel ä¸ user space ä¹‹é—´çš„ context switch**ï¼›kernel æä¾›äº† page cache é«˜æ•ˆçš„ç¼“å­˜ç®¡ç†ï¼›å†…å­˜è¢«å…±äº«æ—¶ kernel æä¾›äº†åŒæ­¥åŠŸèƒ½ã€‚é™¤äº† mmapï¼Œé…åˆ `mlock()`ã€`madvise()`ã€`msync()`ï¼Œå¼€å‘è€…èƒ½å¤Ÿæ›´è‡ªç”±çš„æ§åˆ¶ç¼“å­˜ç­–ç•¥ã€‚åƒ MongoDB å°±æ˜¯ä½¿ç”¨ mmap æ¥è¯»å†™æ•°æ®æ–‡ä»¶çš„ã€‚ä½†æ˜¯ç”±äºä½¿ç”¨ madvise çš„äººä¸å¤šï¼Œkernel å¥½åƒå¹¶æ²¡æœ‰åˆ©ç”¨ madvise ä¿¡æ¯ï¼Œæˆ–è€…æ•ˆæœä¸æ˜¯å¾ˆå¥½$[12]$ã€‚ æ–‡ä¸­æœ€åæäº†è¿™ç§æ–¹å¼å¦‚ä½•åº”å¯¹é«˜å¹¶å‘çš„è¯·æ±‚ï¼Œå¹¶æäº†ä¸€äº›è§£å†³æ–¹æ¡ˆã€‚

Coroutineï¼Œç”¨æˆ·çº§çš„åç¨‹çš„å¥½å¤„å°±æ˜¯æ¯” thread çš„å¼€é”€æ›´å°ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜ï¼Œä¸€æ—¦ä¸€ä¸ªåç¨‹è°ƒç”¨ç³»ç»Ÿè°ƒç”¨é˜»å¡æ—¶ï¼ˆå¦‚ç­‰å¾… I/Oï¼‰ï¼Œåç¨‹æ‰€å±çš„çº¿ç¨‹å°±ä¼šé˜»å¡ï¼Œä¹Ÿå°±æ„å‘³ç€å…¶ä»–åç¨‹ä¹Ÿè¦è·Ÿç€é˜»å¡ã€‚è¿™é‡Œæœ‰å‡ ç§è§£å†³æ–¹æ¡ˆï¼š

1. å¦‚æœèƒ½å¤Ÿå®¹å¿é˜»å¡å¯¹æ€§èƒ½çš„å½±å“ï¼Œå°±ä¸åšå¤„ç†ã€‚
2. ä¸ºé˜»å¡çš„åç¨‹æ–°å»ºä¸€ä¸ªå†…æ ¸çº¿ç¨‹ä¸“é—¨ç­‰å¾…ç³»ç»Ÿè°ƒç”¨å®Œæˆï¼Œè¿™æ ·å…¶ä»–åç¨‹å°±å¯ä»¥ç»§ç»­ï¼Œ Goroutine é‡‡ç”¨çš„å°±æ˜¯è¿™ç§æœºåˆ¶ã€‚
3. ä½¿ç”¨ NonblockingIOï¼Œæ–‡ä¸­æåˆ°äº† epoll+eventfd$[14]$ã€‚`Epoll` æ˜¯ linux ä¸‹çš„ä¸€ç§å¤šè·¯å¤ç”¨æŠ€æœ¯ï¼ŒåŠŸèƒ½ä¸ `select`ï¼Œ`poll` ä¸€æ ·ï¼Œeventfd åˆ™ä¸ pipe æœ‰ç‚¹åƒï¼Œå®ƒé€šè¿‡åˆ›å»ºçš„äº‹ä»¶å¯¹è±¡æ¥è¯»å†™ä¸€ä¸ª 64 ä½çš„æ•´æ•°è®¡æ•°å™¨ï¼Œçº¿ç¨‹ä¹‹é—´é€šè¿‡åå•†å¥½äº‹ä»¶å¯¹åº”çš„æ•°å€¼æ¥åè°ƒé€šä¿¡ã€‚
4. å¯¹äº O_DIRECT è®¿é—® Diskï¼Œä½¿ç”¨å¼‚æ­¥ IOï¼Œå½“ç„¶ä¹Ÿå¯ä¸€é…åˆ epoll ä½¿ç”¨ã€‚

$[1]$æ–‡ä¸­çš„è¯„è®ºç»™å‡ºäº†ä¸€äº›ä¸åŒçœ‹æ³•ï¼š 

1. **é¢‘ç¹çš„ä½¿ç”¨ mmap ä¼šå¾ˆå®¹æ˜“è€—å°½å†…å­˜çš„èµ„æº**ï¼Œç‰¹åˆ«å¯¹äº 32 ä½çš„æœºå™¨ã€‚ä½œè€…æå‡ºå¯ä»¥ä½¿ç”¨ cgroups$[15]$æ¥æ§åˆ¶èµ„æºçš„ä½¿ç”¨ã€‚ 
2. mmap å¹¶ä¸é€‚åˆé‚£ç§ write-only çš„åœºæ™¯ï¼Œæˆ–è€…è¯´è¿™ä¸ªæ—¶å€™æ²¡ä»€ä¹ˆæ€§èƒ½ä¼˜åŠ¿ï¼Œè€Œ database çš„ commit log å°±å±äºè¿™ä¸€ç±»å‹ã€‚ 
3. mmap ä¸èƒ½æä¾›ä¸€äº›çµæ´»çš„æ§åˆ¶ç¼“å­˜çš„éœ€æ±‚ï¼Œä¾‹å¦‚æ§åˆ¶ä¸åŒç¼“å­˜å—çš„å†™å…¥é¡ºåºç­‰ç­‰ã€‚

> å›¾3ï¼šLinuxè™šæ‹Ÿå†…å­˜ç©ºé—´ï¼ˆæˆªå›¾è‡ª CSAPP ç¬¬äºŒç‰ˆï¼‰

![img](https://cdn.jsdelivr.net/gh/Wu-yikun/OSS/PicGo/202411011725615.jpeg)

> å›¾4ï¼šLinux è™šæ‹Ÿå†…å­˜ç©ºé—´å¯¹åº”çš„é‡è¦æ•°æ®ç»“æ„$[16]$

![img](https://cdn.jsdelivr.net/gh/Wu-yikun/OSS/PicGo/202411011726033.jpeg)

## Page Cache

ä¸Šæ–‡çš„è®¨è®ºä¸­ï¼Œæ¶‰åŠåˆ°ä¸€ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µâ€”â€”Page Cacheï¼Œç®€å•æ¦‚æ‹¬ï¼Œå°±æ˜¯ç£ç›˜çš„æ•°æ®ä»¥é¡µå¼ç¼“å­˜çš„å½¢å¼ä¿å­˜åœ¨å†…å­˜ä¸­ã€‚å¯ä»¥ä»ä¸¤ä¸ªæ–¹é¢å»ç†è§£ Page å’Œ Cacheã€‚

- Cacheï¼šç¼“å­˜å­˜åœ¨çš„æœ€ä¸»è¦ç›®çš„ä¸ºäº†è§£å†³è®¾å¤‡è¯»å†™é€Ÿåº¦ä¸å‡æ¨ªçš„é—®é¢˜ã€‚ä¾‹å¦‚å†…å­˜å¯ä»¥ç†è§£ä¸º Disk ç­‰è®¾å¤‡çš„ç¼“å­˜ï¼ŒCPU Cache å¯ä»¥ç†è§£ä¸ºå†…å­˜çš„ç¼“å­˜ã€‚å›¾ 5 ç»™å‡ºäº†ä¼ ç»Ÿè®¡ç®—æœºå„ä¸ªéƒ¨ä»¶çš„é€Ÿåº¦ï¼Œéå¸¸çš„ç›´è§‚ã€‚ç®€å•è¯´ä¸€ä¸ªå¥½çš„ç¼“å­˜è®¾è®¡å¯ä»¥å¤§å¤§æé«˜ç³»ç»Ÿ IO çš„æ€§èƒ½ã€‚
- Pageï¼šPage æ˜¯ Disk block åœ¨å†…å­˜ä¸­çš„ç¼“å­˜ç»“æ„ï¼Œç±»ä¼¼çš„ Cache Line æ˜¯å†…å­˜æ•°æ®åœ¨ CPU Cache ä¸­çš„ç¼“å­˜å•å…ƒã€‚ä¸€èˆ¬ Page å¤§å°æ˜¯å¯é…ç½®çš„ï¼Œä¸€èˆ¬æ˜¯ Disk block çš„å€æ•°ï¼Œä½†æ˜¯ä¸€ä¸ª Page å¯¹åº”çš„å¤šä¸ª block åœ¨ Disk ä¸­ä¸ä¸€å®šæ˜¯è¿ç»­çš„ã€‚

ä¸€ä¸ªé«˜æ•ˆçš„ç¼“å­˜ï¼Œå¿…ç„¶ä¼šæ¶‰åŠåˆ°å‡ ä¸ªé—®é¢˜ã€‚

**ç¼“å­˜æ›¿æ¢ç®—æ³•**ï¼šæœ€æœ‰åè«è¿‡äº LRU (Least Recently Used) ç®—æ³•ï¼Œä½†æ˜¯ LRU åœ¨æ‰¹é‡è¯»å†™å¤§æ–‡ä»¶çš„æ—¶å€™ï¼Œä¼šæ¸…ç©ºå½“å‰ç¼“å­˜ï¼Œè€Œå¦‚æœè¯»å–çš„å¤§æ–‡ä»¶åªæ˜¯è¯»å–ä¸€æ¬¡ï¼Œé‚£ä¹ˆæ„å‘³ç€ä¹‹å‰ç¼“å­˜çš„æ•°æ®åˆè¦ä»ç£ç›˜é‡æ–°è¯»å–ï¼Œä¸ºäº†é¿å…è¿™ç§æƒ…å†µ Kernel ä½¿ç”¨ä¸¤æ¡é“¾è¡¨ï¼Œä¸€æ¡ Hot é“¾è¡¨ï¼Œå­˜çš„æ˜¯è¢«è®¿é—®ä¸€æ¬¡ä»¥ä¸Šçš„æ•°æ®ï¼Œè€Œå¦ä¸€ä¸ªé“¾è¡¨å­˜æ”¾ç¬¬ä¸€æ¬¡è¯»å–çš„ Pageï¼Œä¸¤ä¸ªé“¾è¡¨éƒ½ä½¿ç”¨ LRU ç®—æ³•ã€‚

**æ•°æ®å†™å›ä¾§ç­–ç•¥**ï¼šä¸»è¦ä¸¤ç§ï¼šwrite through å’Œ write backã€‚Kernel ä¸ºäº†æ•ˆç‡ä½¿ç”¨ write backã€‚åå°ä½¿ç”¨ flush çº¿ç¨‹å°† page cache ä¸ç£ç›˜ç­‰è®¾å¤‡åŒæ­¥ã€‚æœ‰ä¸‰ç§æƒ…å†µä¼šè§¦å‘è¿™ä¸ªåŒæ­¥çº¿ç¨‹ï¼š

1. å†…å­˜ç©ºé—²ï¼ˆæœªä¸ç£ç›˜åŒæ­¥ï¼‰é¡µè¡¨æ•°ä½äºç³»ç»Ÿè®¾å®šé˜ˆå€¼ï¼›
2. dirty çš„é¡µåœ¨å†…å­˜ä¸­å­˜åœ¨è¶…è¿‡ç³»ç»Ÿè®¾ç½®çš„æ—¶é—´ï¼›
3. ç”¨æˆ·è°ƒç”¨ `sync()`ï¼Œ`fsync()` ç³»ç»Ÿè°ƒç”¨ã€‚Linux Kernel ä¸­ flush çš„çº¿ç¨‹æ•°ç›®ç­‰äºç³»ç»Ÿç£ç›˜ï¼ˆæŒä¹…åŒ–è®¾å¤‡ï¼‰çš„ä¸ªæ•°ï¼Œå…¶å®åŒæ­¥çº¿ç¨‹æœ‰ä¸€ä¸ªæ¼”åŒ–çš„è¿‡ç¨‹ï¼Œä» bdflush å’Œ kupdated é…åˆä½¿ç”¨åˆ°åŠ¨æ€ä¸ªæ•°çš„ pdflush çº¿ç¨‹å†åˆ°ç°åœ¨çš„ä¸å¤–éƒ¨è®¾å¤‡ç­‰ä¸ªæ•°çš„ flush çº¿ç¨‹ã€‚å…·ä½“å¯å‚è€ƒ$[17]$ã€‚

**å¦‚ä½•é«˜æ•ˆåˆ¤æ–­æ•°æ®å·²åœ¨ç¼“å­˜ä¸­**ï¼šKernel ä¸­ä½¿ç”¨ **Radix Tree** è¿›è¡Œç´¢å¼•ï¼Œåœ¨ 2.6 ç‰ˆæœ¬ä»¥å‰ä½¿ç”¨å…¨å±€çš„ Hash Table æ•ˆç‡è¾ƒä½ã€‚ç°åœ¨æ˜¯æ¯ä¸ªæ–‡ä»¶éƒ½ä¼šæœ‰ä¸€ä¸ª radix treeã€‚æä¾›ä¸€ä¸ªæ–‡ä»¶çš„åç§»å€¼ï¼ˆåç§»å€¼å¯¹åº” radix tree çš„ keyï¼‰ï¼Œå¯ä»¥åœ¨å¸¸æ•°ï¼ˆä¸åç§»å€¼çš„ä½æ•°æœ‰å…³ï¼‰æ—¶é—´å†…æ‰¾åˆ°å¯¹åº”çš„ page é¡¹ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™å…ˆåˆ†é…ä¸€ä¸ªï¼Œå†è¿”å›ï¼Œå¹¶ä¸”æ¯ä¸ª page é¡¹è¡¨æ˜äº†æ˜¯å¦ dirty ç­‰ä¿¡æ¯ã€‚**Radix Tree æ˜¯ Trie çš„å‹ç¼©ç‰ˆæœ¬ï¼ŒTrie æ˜¯ä¸€ä¸ªèŠ‚ç‚¹ä¸€ä¸ªå­—ç¬¦ï¼ŒRadix Tree å…è®¸å¤šä¸ªå­—ç¬¦ã€‚**

æœ‰å…³ Page Cache çš„æ›´ç»†èŠ‚çš„ä¸œè¥¿ï¼Œå¯ä»¥å‚è€ƒã€ŠLinux kernel developmentã€‹$[17]$ç¬¬13 ç« ã€‚

> å›¾5ï¼šä¸€ä¸ªå…¸å‹ X86 æ¶æ„å„ä¸ªéƒ¨ä»¶çš„é€Ÿåº¦$[16]$

![img](https://cdn.jsdelivr.net/gh/Wu-yikun/OSS/PicGo/202411011738428.png)