---
title: å †ï¼ˆä¼˜å…ˆé˜Ÿåˆ—ï¼‰
description: priority_queue åˆç§°ä¸º Heap
publishDate: 2025-07-20
tags: [leetcode]
heroImage: { src: ../_img/202501222250241.jpeg }
language: Chinese
comment: true
draft: false
---

## âœ… ä¼˜å…ˆé˜Ÿåˆ— `priority_queue`

> æ›´å¤šå…³äºä¼˜å…ˆé˜Ÿåˆ—çš„çŸ¥è¯†ï¼Œè¯·è·³è½¬è‡³ï¼šhttps://en.oi-wiki.org/lang/pb-ds/pq/

- å¤§é¡¶å †ï¼š`priority_queue<int> pq`

- å°é¡¶å †ï¼š`priority_queue<int, vector<int>, greater<>> pq`

**ç›¸å…³ä¾‹é¢˜**ï¼š

- [1046. æœ€åä¸€å—çŸ³å¤´çš„é‡é‡](https://leetcode.cn/problems/last-stone-weight/)
- [347. å‰ K ä¸ªé«˜é¢‘å…ƒç´ ](https://leetcode.cn/problems/top-k-frequent-elements/)
- ğŸ”¥[239. æ»‘åŠ¨çª—å£æœ€å¤§å€¼](https://leetcode.cn/problems/sliding-window-maximum/)ï¼ˆè¿˜å¯ä»¥æ‰‹åŠ¨æ„é€ ä¸€ä¸ªå•è°ƒé˜Ÿåˆ—ï¼Œä½¿ç”¨ `deque` æ•°æ®ç»“æ„ï¼‰
- ğŸ”¥[295. æ•°æ®æµçš„ä¸­ä½æ•°](https://leetcode.cn/problems/find-median-from-data-stream/)
- ğŸ”¥[480. æ»‘åŠ¨çª—å£ä¸­ä½æ•°](https://leetcode.cn/problems/sliding-window-median/)

### `__gnu_pbds :: priority_queue`

é™„ï¼š [å®˜æ–¹æ–‡æ¡£åœ°å€â€”â€”å¤æ‚åº¦åŠå¸¸æ•°æµ‹è¯•](https://gcc.gnu.org/onlinedocs/libstdc++/ext/pb_ds/pq_performance_tests.html#std_mod1)

```cpp
#include <ext/pb_ds/priority_queue.hpp>
using namespace __gnu_pbds;
__gnu_pbds ::priority_queue<T, Compare, Tag, Allocator>
```

**æ¨¡æ¿å½¢å‚**ï¼š

- `T` : å‚¨å­˜çš„å…ƒç´ ç±»å‹
- `Compare` : æä¾›ä¸¥æ ¼çš„å¼±åºæ¯”è¾ƒç±»å‹
- `Tag` æ˜¯ `__gnu_pbds` æä¾›çš„ä¸åŒçš„äº”ç§å †ï¼Œ**`Tag` å‚æ•°é»˜è®¤æ˜¯ `pairing_heap_tag`**ï¼Œè¿™äº”ç§åˆ†åˆ«æ˜¯ï¼š
    - `pairing_heap_tag` ï¼šé…å¯¹å †ï¼Œå®˜æ–¹æ–‡æ¡£è®¤ä¸ºåœ¨éåŸç”Ÿå…ƒç´ ï¼ˆå¦‚è‡ªå®šä¹‰ç»“æ„ä½“/ `std :: string` / `pair` ) ä¸­ï¼Œé…å¯¹å †è¡¨ç°æœ€å¥½
    - `binary_heap_tag` ï¼šäºŒå‰å †ï¼Œå®˜æ–¹æ–‡æ¡£è®¤ä¸ºåœ¨åŸç”Ÿå…ƒç´ ä¸­äºŒå‰å †è¡¨ç°æœ€å¥½ï¼Œä¸è¿‡æˆ‘æµ‹è¯•çš„è¡¨ç°å¹¶æ²¡æœ‰é‚£ä¹ˆå¥½
    - `binomial_heap_tag` ï¼šäºŒé¡¹å †ï¼ŒäºŒé¡¹å †åœ¨åˆå¹¶æ“ä½œçš„è¡¨ç°è¦ä¼˜äºé…å¯¹å †*ä½†æ˜¯å…¶å–å †é¡¶å…ƒç´ çš„
    - `rc_binomial_heap_tag` ï¼šå†—ä½™è®¡æ•°äºŒé¡¹å †
    - `thin_heap_tag` ï¼šé™¤äº†åˆå¹¶çš„å¤æ‚åº¦éƒ½å’Œ Fibonacci å †ä¸€æ ·çš„ä¸€ä¸ª tag
- `Allocator` ï¼šç©ºé—´é…ç½®å™¨ï¼Œç”±äº OI ä¸­å¾ˆå°‘å‡ºç°ï¼Œæ•…è¿™é‡Œä¸åšè®²è§£

> ç”±äºæœ¬ç¯‡æ–‡ç« åªæ˜¯æä¾›ç»™å­¦ä¹ ç®—æ³•ç«èµ›çš„åŒå­¦ä»¬ï¼Œæ•…å¯¹äºåå››ä¸ª tag åªä¼šç®€å•çš„ä»‹ç»å¤æ‚åº¦ï¼Œç¬¬ä¸€ä¸ªä¼šä»‹ç»æˆå‘˜å‡½æ•°å’Œä½¿ç”¨æ–¹æ³•ã€‚

ç»ä½œè€…æœ¬æœºæµ‹è¯•å †çš„åŸºç¡€æ“ä½œï¼Œç»“åˆ GNU å®˜æ–¹çš„å¤æ‚åº¦æµ‹è¯•ï¼ŒDijkstra æµ‹è¯•ï¼Œéƒ½è¡¨æ˜ï¼šè‡³å°‘å¯¹äº OIer æ¥è®²ï¼Œé™¤äº†é…å¯¹å †ï¼ˆå³é»˜è®¤ tagï¼‰çš„å…¶ä»–å››ä¸ª tag éƒ½æ˜¯é¸¡è‚‹ï¼Œè¦ä¹ˆæ²¡ç”¨ï¼Œè¦ä¹ˆå¸¸æ•°å¤§åˆ°ä¸å¦‚ `std` çš„ï¼Œä¸”æœ‰å¯èƒ½é€ æˆ `MLE`ï¼Œæ•…è¿™é‡Œåªæ¨èç”¨é»˜è®¤çš„é…å¯¹å †ã€‚åŒæ ·ï¼Œé…å¯¹å †ä¹Ÿä¼˜äº `algorithm` åº“ä¸­çš„ `make_heap()` ã€‚

### æ„é€ æ–¹å¼

è¦æ³¨æ˜å‘½åç©ºé—´å› ä¸ºå’Œ `std` çš„ç±»åç§°é‡å¤ã€‚

```cpp
__gnu_pbds ::priority_queue<int> __gnu_pbds::priority_queue<int, greater<int> >
__gnu_pbds ::priority_queue<int, greater<int>, pairing_heap_tag>
__gnu_pbds ::priority_queue<int>::point_iterator id; // è¿­ä»£å™¨
// åœ¨ modify å’Œ push çš„æ—¶å€™éƒ½ä¼šè¿”å›ä¸€ä¸ª point_iteratorï¼Œä¸‹æ–‡ä¼šè¯¦ç»†çš„è®²ä½¿ç”¨æ–¹æ³•
id = q.push(1);
```

### æˆå‘˜å‡½æ•°

- `push()` : å‘å †ä¸­å‹å…¥ä¸€ä¸ªå…ƒç´ ï¼Œè¿”å›è¯¥å…ƒç´ ä½ç½®çš„è¿­ä»£å™¨ã€‚
- `pop()` : å°†å †é¡¶å…ƒç´ å¼¹å‡ºã€‚
- `top()` : è¿”å›å †é¡¶å…ƒç´ ã€‚
- `size()` è¿”å›å…ƒç´ ä¸ªæ•°ã€‚
- `empty()` è¿”å›æ˜¯å¦éç©ºã€‚
- `modify(point_iterator, const key)` : æŠŠè¿­ä»£å™¨ä½ç½®çš„ `key` ä¿®æ”¹ä¸ºä¼ å…¥çš„ `key` ï¼Œå¹¶å¯¹åº•å±‚å‚¨å­˜ç»“æ„è¿›è¡Œæ’åºã€‚
- `erase(point_iterator)` : æŠŠè¿­ä»£å™¨ä½ç½®çš„é”®å€¼ä»å †ä¸­æ“¦é™¤ã€‚
- `join(__gnu_pbds :: priority_queue &other)` : æŠŠ `other` åˆå¹¶åˆ° `*this` å¹¶æŠŠ `other` æ¸…ç©ºã€‚

### æ—¶é—´å¤æ‚åº¦

ä½¿ç”¨çš„ tag å†³å®šäº†æ¯ä¸ªæ“ä½œçš„æ—¶é—´å¤æ‚åº¦ï¼š

![](https://cdn.jsdelivr.net/gh/Wu-yikun/OSS/PicGo/202507201751959.png)

## 239. æ»‘åŠ¨çª—å£æœ€å¤§å€¼

ç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„ `nums`ï¼Œæœ‰ä¸€ä¸ªå¤§å°ä¸º `k` çš„æ»‘åŠ¨çª—å£ä»æ•°ç»„çš„æœ€å·¦ä¾§ç§»åŠ¨åˆ°æ•°ç»„çš„æœ€å³ä¾§ã€‚ä½ åªå¯ä»¥çœ‹åˆ°åœ¨æ»‘åŠ¨çª—å£å†…çš„ `k` ä¸ªæ•°å­—ã€‚æ»‘åŠ¨çª—å£æ¯æ¬¡åªå‘å³ç§»åŠ¨ä¸€ä½ã€‚

è¿”å› æ»‘åŠ¨çª—å£ä¸­çš„æœ€å¤§å€¼ ã€‚

```cpp
è¾“å…¥ï¼šnums = [1,3,-1,-3,5,3,6,7], k = 3
è¾“å‡ºï¼š[3,3,5,5,6,7]
è§£é‡Šï¼š
æ»‘åŠ¨çª—å£çš„ä½ç½®                æœ€å¤§å€¼
---------------               -----
[1  3  -1] -3  5  3  6  7       3
 1 [3  -1  -3] 5  3  6  7       3
 1  3 [-1  -3  5] 3  6  7       5
 1  3  -1 [-3  5  3] 6  7       5
 1  3  -1  -3 [5  3  6] 7       6
 1  3  -1  -3  5 [3  6  7]      7
```

```cpp
class Solution {
public:
    vector<int> maxSlidingWindow(vector<int>& nums, int k) {
        // entry: <val, idx (whether_expired)>
        priority_queue<pair<int, int>, vector<pair<int, int>>, less<>> pq;
        for (int i = 0; i < k; i++) {
            pq.emplace(nums[i], i);
        }
        vector<int> ans{pq.top().first};
        for (int i = k; i < nums.size(); i++) {
            pq.emplace(nums[i], i);
            while (pq.top().second <= i - k) {
                pq.pop();
            }
            ans.push_back(pq.top().first);
        }
        return ans;
    }
};
```

## 295. æ•°æ®æµçš„ä¸­ä½æ•°

**ä¸­ä½æ•°**æ˜¯æœ‰åºæ•´æ•°åˆ—è¡¨ä¸­çš„ä¸­é—´å€¼ã€‚å¦‚æœåˆ—è¡¨çš„å¤§å°æ˜¯å¶æ•°ï¼Œåˆ™æ²¡æœ‰ä¸­é—´å€¼ï¼Œä¸­ä½æ•°æ˜¯ä¸¤ä¸ªä¸­é—´å€¼çš„å¹³å‡å€¼ã€‚

- ä¾‹å¦‚ `arr = [2,3,4]` çš„ä¸­ä½æ•°æ˜¯ `3` ã€‚
- ä¾‹å¦‚ `arr = [2,3]` çš„ä¸­ä½æ•°æ˜¯ `(2 + 3) / 2 = 2.5` ã€‚

å®ç° MedianFinder ç±»:

- `MedianFinder() `åˆå§‹åŒ– `MedianFinder` å¯¹è±¡ã€‚
- `void addNum(int num)` å°†æ•°æ®æµä¸­çš„æ•´æ•° `num` æ·»åŠ åˆ°æ•°æ®ç»“æ„ä¸­ã€‚
- `double findMedian()` è¿”å›åˆ°ç›®å‰ä¸ºæ­¢æ‰€æœ‰å…ƒç´ çš„ä¸­ä½æ•°ã€‚ä¸å®é™…ç­”æ¡ˆç›¸å·® `10-5` ä»¥å†…çš„ç­”æ¡ˆå°†è¢«æ¥å—ã€‚

```cpp
è¾“å…¥
["MedianFinder", "addNum", "addNum", "findMedian", "addNum", "findMedian"]
[[], [1], [2], [], [3], []]
è¾“å‡º
[null, null, null, 1.5, null, 2.0]

è§£é‡Š
MedianFinder medianFinder = new MedianFinder();
medianFinder.addNum(1);    // arr = [1]
medianFinder.addNum(2);    // arr = [1, 2]
medianFinder.findMedian(); // è¿”å› 1.5 ((1 + 2) / 2)
medianFinder.addNum(3);    // arr[1, 2, 3]
medianFinder.findMedian(); // return 2.0
```

```cpp
class MedianFinder {
private:
    priority_queue<int> left;                          // å¤§é¡¶å †
    priority_queue<int, vector<int>, greater<>> right; // å°é¡¶å †

public:
    MedianFinder() {}

    void addNum(int num) {
        // åˆ†ç±»è®¨è®º, å¹¶ä¸”åˆå¹¶ä¸ºæœ€ç»ˆä¸¤ç§æƒ…å†µ
        if (left.size() == right.size()) {
            right.push(num);
            left.push(right.top());
            right.pop();
        } else {
            left.push(num);
            right.push(left.top());
            left.pop();
        }
    }

    double findMedian() {
        return (left.size() + right.size()) % 2
                   ? left.top()
                   : static_cast<double>(left.top() + right.top()) / 2;
    }
};
```

## 480. æ»‘åŠ¨çª—å£ä¸­ä½æ•°

ä¸­ä½æ•°æ˜¯æœ‰åºåºåˆ—æœ€ä¸­é—´çš„é‚£ä¸ªæ•°ã€‚å¦‚æœåºåˆ—çš„é•¿åº¦æ˜¯å¶æ•°ï¼Œåˆ™æ²¡æœ‰æœ€ä¸­é—´çš„æ•°ï¼›æ­¤æ—¶ä¸­ä½æ•°æ˜¯æœ€ä¸­é—´çš„ä¸¤ä¸ªæ•°çš„å¹³å‡æ•°ã€‚

ä¾‹å¦‚ï¼š

- `[2,3,4]`ï¼Œä¸­ä½æ•°æ˜¯ `3`
- `[2,3]`ï¼Œä¸­ä½æ•°æ˜¯ `(2 + 3) / 2 = 2.5`

ç»™ä½ ä¸€ä¸ªæ•°ç»„ *nums*ï¼Œæœ‰ä¸€ä¸ªé•¿åº¦ä¸º *k* çš„çª—å£ä»æœ€å·¦ç«¯æ»‘åŠ¨åˆ°æœ€å³ç«¯ã€‚çª—å£ä¸­æœ‰ *k* ä¸ªæ•°ï¼Œæ¯æ¬¡çª—å£å‘å³ç§»åŠ¨ *1* ä½ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰¾å‡ºæ¯æ¬¡çª—å£ç§»åŠ¨åå¾—åˆ°çš„æ–°çª—å£ä¸­å…ƒç´ çš„ä¸­ä½æ•°ï¼Œå¹¶è¾“å‡ºç”±å®ƒä»¬ç»„æˆçš„æ•°ç»„ã€‚

ç»™å‡º *nums* = `[1,3,-1,-3,5,3,6,7]`ï¼Œä»¥åŠ *k* = 3ã€‚

```cpp
çª—å£ä½ç½®                      ä¸­ä½æ•°
---------------               -----
[1  3  -1] -3  5  3  6  7       1
 1 [3  -1  -3] 5  3  6  7      -1
 1  3 [-1  -3  5] 3  6  7      -1
 1  3  -1 [-3  5  3] 6  7       3
 1  3  -1  -3 [5  3  6] 7       5
 1  3  -1  -3  5 [3  6  7]      6
```

 å› æ­¤ï¼Œè¿”å›è¯¥æ»‘åŠ¨çª—å£çš„ä¸­ä½æ•°æ•°ç»„ `[1,-1,-1,3,5,6]`ã€‚

### 1ï¸âƒ£ å“ˆå¸Œè¡¨ + é€»è¾‘åˆ é™¤

```cpp
class Solution {
public:
    priority_queue<int> left;                          // æ»‘åŠ¨çª—å£ä¸­å·¦åŠéƒ¨åˆ†
    priority_queue<int, vector<int>, greater<>> right; // æ»‘åŠ¨çª—å£ä¸­å³åŠéƒ¨åˆ†
    unordered_map<int, int> mp;                        // ç”¨äºé€»è¾‘åˆ é™¤

    double get(int k) {
        if (k % 2)
            return left.top();
        else
            return ((long long)left.top() + right.top()) / 2.0;
    }

    vector<double> medianSlidingWindow(vector<int>& nums, int k) {
        for (int i = 0; i < k; i++) {
            int x = nums[i];
            if (left.size() == right.size()) {
                right.push(x);
                left.push(right.top());
                right.pop();
            } else {
                left.push(x);
                right.push(left.top());
                left.pop();
            }
        }
        vector<double> ans{get(k)};

        for (int i = k; i < nums.size(); i++) {
            int balance = 0; // right.size() - left.size()

            // [fake] delete
            int l_num = nums[i - k];
            mp[l_num]++;
            if (!left.empty() && l_num <= left.top()) {
                balance++;
            } else {
                balance--;
            }

            // add
            if (!left.empty() && nums[i] <= left.top()) {
                left.push(nums[i]);
                balance--;
            } else {
                right.push(nums[i]);
                balance++;
            }

            // adjust
            if (balance > 0) {
                left.push(right.top());
                right.pop();
            } else if (balance < 0) {
                right.push(left.top());
                left.pop();
            }

            // delete
            while (!left.empty() && mp[left.top()] > 0) {
                mp[left.top()]--;
                left.pop();
            }
            while (!right.empty() && mp[right.top()] > 0) {
                mp[right.top()]--;
                right.pop();
            }

            ans.push_back(get(k));
        }
        return ans;
    }
}
```

### 2ï¸âƒ£ æ‡’åˆ é™¤å †

> æœ¬é¢˜ç­‰ä»·äºï¼š295. æ•°æ®æµçš„ä¸­ä½æ•° + æ‡’åˆ é™¤å †

```cpp
template<typename T, typename Compare = less<T>>
class LazyHeap {
    priority_queue<T, vector<T>, Compare> pq;
    unordered_map<T, int> remove_cnt; // æ¯ä¸ªå…ƒç´ å‰©ä½™éœ€è¦åˆ é™¤çš„æ¬¡æ•°
    size_t sz = 0; // å®é™…å¤§å°

    // æ­£å¼æ‰§è¡Œåˆ é™¤æ“ä½œ
    void apply_remove() {
        while (!pq.empty() && remove_cnt[pq.top()] > 0) {
            remove_cnt[pq.top()]--;
            pq.pop();
        }
    }

public:
    size_t size() {
        return sz;
    }

    // åˆ é™¤
    void remove(T x) {
        remove_cnt[x]++; // æ‡’åˆ é™¤
        sz--;
    }

    // æŸ¥çœ‹å †é¡¶
    T top() {
        apply_remove();
        return pq.top();
    }

    // å‡ºå †
    T pop() {
        apply_remove();
        sz--;
        T x = pq.top();
        pq.pop();
        return x;
    }

    // å…¥å †
    void push(T x) {
        if (remove_cnt[x] > 0) {
            remove_cnt[x]--; // æŠµæ¶ˆä¹‹å‰çš„åˆ é™¤
        } else {
            pq.push(x);
        }
        sz++;
    }

    // push(x) ç„¶å pop()
    T push_pop(T x) {
        apply_remove();
        pq.push(x);
        x = pq.top();
        pq.pop();
        return x;
    }
};

class Solution {
public:
    vector<double> medianSlidingWindow(vector<int>& nums, int k) {
        int n = nums.size();
        vector<double> ans(n - k + 1);
        LazyHeap<int> left; // æœ€å¤§å †
        LazyHeap<int, greater<int>> right; // æœ€å°å †

        for (int i = 0; i < n; i++) {
            // 1. è¿›å…¥çª—å£
            int in = nums[i];
            if (left.size() == right.size()) {
                left.push(right.push_pop(in));
            } else {
                right.push(left.push_pop(in));
            }

            int l = i + 1 - k;
            if (l < 0) { // çª—å£å¤§å°ä¸è¶³ k
                continue;
            }

            // 2. è®¡ç®—ç­”æ¡ˆ
            if (k % 2) {
                ans[l] = left.top();
            } else {
                ans[l] = ((long long) left.top() + right.top()) / 2.0;
            }

            // 3. ç¦»å¼€çª—å£
            int out = nums[l];
            if (out <= left.top()) {
                left.remove(out);
                if (left.size() < right.size()) {
                    left.push(right.pop()); // å¹³è¡¡ä¸¤ä¸ªå †çš„å¤§å°
                }
            } else {
                right.remove(out);
                if (left.size() > right.size() + 1) {
                    right.push(left.pop()); // å¹³è¡¡ä¸¤ä¸ªå †çš„å¤§å°
                }
            }
        }

        return ans;
    }
};
```
